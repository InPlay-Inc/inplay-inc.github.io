<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Inplay Transparent Data Transmission (TRx) profile User Guide # Overview # The Inplay Transparent Data Transmission (TRx) profile is a GATT based profile that fullfill tranparent data transmission function through BLE protocol. It encapsulates most of the details of the protocol stack and provides a simple interface to facilitate application development. For Inplay BLE application development, please refer to &mldr; For details about GATT programming please refer to GATT Programming Guide"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:title" content="Inplay Transparent Data Transmission (TRx) profile User Guide"><meta property="og:description" content="Inplay Transparent Data Transmission (TRx) profile User Guide # Overview # The Inplay Transparent Data Transmission (TRx) profile is a GATT based profile that fullfill tranparent data transmission function through BLE protocol. It encapsulates most of the details of the protocol stack and provides a simple interface to facilitate application development. For Inplay BLE application development, please refer to &mldr; For details about GATT programming please refer to GATT Programming Guide"><meta property="og:type" content="article"><meta property="og:url" content="/docs/in6xxe/protocols-reference/ble/inplay_trx_profile.html"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2025-03-26T15:48:01+08:00"><title>Inplay Transparent Data Transmission (TRx) profile User Guide | InPlay Doc</title>
<link rel=manifest href=../../../../manifest.json><link rel=icon href=../../../../favicon.png><link rel=stylesheet href=../../../../book.min.7b5ca60448c7e874974d6d12156f89c2b32da59c25ae776b2522852d3ebb0865.css><script defer src=../../../../flexsearch.min.js></script><script defer src=../../../../en.search.min.59d33ac273f2e156da2254c9956c77ecc19d8d54054f3fd990747f18ca2a3380.js></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=../../../../><span>InPlay Doc</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><input type=checkbox id=section-ee8b8fb3a2ebd2cf7f56e1b840730602 class=toggle>
<label for=section-ee8b8fb3a2ebd2cf7f56e1b840730602 class="flex justify-between"><a role=button>IN100</a></label><ul></ul></li><li><span>IN6XXE</span><ul><li><input type=checkbox id=section-10a602a2afbac6b637ea6cafedc74c08 class=toggle>
<label for=section-10a602a2afbac6b637ea6cafedc74c08 class="flex justify-between"><a role=button>Getting Started</a></label><ul><li><input type=checkbox id=section-c0533e207424bbd85c1ed5e367c68a38 class=toggle>
<label for=section-c0533e207424bbd85c1ed5e367c68a38 class="flex justify-between"><a role=button>Installation</a></label><ul><li><a href=../../../../docs/in6xxe/getting-started/installation/quick-start.html>Quick Start</a></li><li><a href=../../../../docs/in6xxe/getting-started/installation/quick-start-with-gcc.html>Quick Start with GCC</a></li><li><a href=../../../../docs/in6xxe/getting-started/installation/run-zephyr-on-in6xxe.html>Run Zephyr on IN6XXE</a></li></ul></li><li><input type=checkbox id=section-4ee5b2397a599e035459a043e9269243 class=toggle>
<label for=section-4ee5b2397a599e035459a043e9269243 class="flex justify-between"><a role=button>Configration and Building</a></label><ul></ul></li><li><input type=checkbox id=section-0fcab4eb5e7d4aac163677313b48ef9d class=toggle>
<label for=section-0fcab4eb5e7d4aac163677313b48ef9d class="flex justify-between"><a role=button>Download Image</a></label><ul><li><a href=../../../../docs/in6xxe/getting-started/download/in_prog-guide.html>InPlay Programmer Guide</a></li><li><a href=../../../../docs/in6xxe/getting-started/download/jflash-download-guide.html>JFlash Programming</a></li></ul></li><li><input type=checkbox id=section-620480f69a74c9672be0a1ecdaca3f9a class=toggle>
<label for=section-620480f69a74c9672be0a1ecdaca3f9a class="flex justify-between"><a role=button>Testing and Debuging</a></label><ul><li><a href=../../../../docs/in6xxe/getting-started/testing/rtt-viewer-guide.html>Rtt Viewer Guide</a></li><li><a href=../../../../docs/in6xxe/getting-started/testing/debug-guide.html>Debug Guide</a></li><li><a href=../../../../docs/in6xxe/getting-started/testing/hci_command.html>HCI Command</a></li></ul></li></ul></li><li><input type=checkbox id=section-e9d08457f4c51bb4cb1e62cc94f322dc class=toggle>
<label for=section-e9d08457f4c51bb4cb1e62cc94f322dc class="flex justify-between"><a role=button>User Guides</a></label><ul><li><input type=checkbox id=section-e7402e460cdffdf6d75edb23894ae0c5 class=toggle>
<label for=section-e7402e460cdffdf6d75edb23894ae0c5 class="flex justify-between"><a role=button>Driver Integration</a></label><ul><li><a href=../../../../docs/in6xxe/user-guides/driver-integration/adc-guide.html>ADC Guide</a></li><li><a href=../../../../docs/in6xxe/user-guides/driver-integration/antenna-diversity.html>Antenna Diversity</a></li><li><a href=../../../../docs/in6xxe/user-guides/driver-integration/aoa-antenna.html>AOA Antenna Guide</a></li><li><a href=../../../../docs/in6xxe/user-guides/driver-integration/counter-development-guide.html>Counter Guide</a></li><li><a href=../../../../docs/in6xxe/user-guides/driver-integration/crc-guide.html>CRC Guide</a></li><li><a href=../../../../docs/in6xxe/user-guides/driver-integration/gpio-guide.html>GPIO Guide</a></li><li><a href=../../../../docs/in6xxe/user-guides/driver-integration/i2c-guide.html>I2C Communication</a></li><li><a href=../../../../docs/in6xxe/user-guides/driver-integration/spi-guide.html>SPI Communication</a></li><li><a href=../../../../docs/in6xxe/user-guides/driver-integration/uart-guide.html>UART Communication</a></li></ul></li><li><input type=checkbox id=section-54628a101b07426659df9579479aa6d8 class=toggle>
<label for=section-54628a101b07426659df9579479aa6d8 class="flex justify-between"><a role=button>NanoSync Technology</a></label><ul><li><a href=../../../../docs/in6xxe/user-guides/nanosync-technology/advanced-timer-guide.html>NanoSync Timer Guide</a></li><li><a href=../../../../docs/in6xxe/user-guides/nanosync-technology/trigger-handler-guide.html>NanoSync Engine Guide</a></li></ul></li></ul></li><li><input type=checkbox id=section-782653f6bb259ea0ac24d90b105a7dc0 class=toggle checked>
<label for=section-782653f6bb259ea0ac24d90b105a7dc0 class="flex justify-between"><a role=button>Protocol Reference</a></label><ul><li><input type=checkbox id=section-5f58fc20691c6de2641f46a033a55d28 class=toggle checked>
<label for=section-5f58fc20691c6de2641f46a033a55d28 class="flex justify-between"><a role=button>BLE</a></label><ul><li><a href=../../../../docs/in6xxe/protocols-reference/ble/inplay-ble5.0-at-command-set.html>BLE5.0 AT Command Set</a></li><li><a href=../../../../docs/in6xxe/protocols-reference/ble/gatt_programming_guild.html>GATT Programming Guide</a></li><li><a href=../../../../docs/in6xxe/protocols-reference/ble/inplay_trx_profile.html class=active>Inplay Transparent Data Transmission (TRx) profile User Guide</a></li></ul></li><li><input type=checkbox id=section-614316ec926d5d4f33757567a52185b7 class=toggle>
<label for=section-614316ec926d5d4f33757567a52185b7 class="flex justify-between"><a role=button>SDR</a></label><ul></ul></li><li><input type=checkbox id=section-7570f1740ec51694c058a21927f48553 class=toggle>
<label for=section-7570f1740ec51694c058a21927f48553 class="flex justify-between"><a role=button>SMULL</a></label><ul><li><a href=../../../../docs/in6xxe/protocols-reference/smull/inplay-smull-development-guide.html>SMULL Command Set</a></li></ul></li></ul></li><li><input type=checkbox id=section-67e1be7c03648874e72d6c95838f0f26 class=toggle>
<label for=section-67e1be7c03648874e72d6c95838f0f26 class="flex justify-between"><a href=../../../../docs/in6xxe/api-documatation.html>API Documentation</a></label><ul></ul></li><li><input type=checkbox id=section-42952569164db7f3f6f894adee6e4523 class=toggle>
<label for=section-42952569164db7f3f6f894adee6e4523 class="flex justify-between"><a role=button>Tools</a></label><ul><li><a href=../../../../docs/in6xxe/tools/ota-app-develop-guide.html>InPlay OTA App Development Guide</a></li><li><a href=../../../../docs/in6xxe/tools/ota-app.html>InPlayOTA App Guide</a></li></ul></li><li><input type=checkbox id=section-df7b9e936bf162d5e2a48a7f82ae2852 class=toggle>
<label for=section-df7b9e936bf162d5e2a48a7f82ae2852 class="flex justify-between"><a role=button>Examples and Use Case</a></label><ul><li><a href=../../../../docs/in6xxe/examples-and-use-case/debug-reference.html>Debug Reference</a></li><li><input type=checkbox id=section-26e2ce46acb4d4970a7850c67da09d8c class=toggle>
<label for=section-26e2ce46acb4d4970a7850c67da09d8c class="flex justify-between"><a role=button>Driver Examples</a></label><ul><li><a href=../../../../docs/in6xxe/examples-and-use-case/driver-examples/adc-sample.html>ADC Sample</a></li><li><a href=../../../../docs/in6xxe/examples-and-use-case/driver-examples/aes-sample.html>AES Sample</a></li><li><a href=../../../../docs/in6xxe/examples-and-use-case/driver-examples/ecc-sample.html>ECC Sample</a></li><li><a href=../../../../docs/in6xxe/examples-and-use-case/driver-examples/gpio-interrupt-sample.html>GPIO Interrupt Sample</a></li><li><a href=../../../../docs/in6xxe/examples-and-use-case/driver-examples/gpio-reset-sample.html>GPIO Reset Sample</a></li><li><a href=../../../../docs/in6xxe/examples-and-use-case/driver-examples/gpio-sample.html>GPIO Sample</a></li><li><a href=../../../../docs/in6xxe/examples-and-use-case/driver-examples/gpio-wake-interrupt-sample.html>GPIO Wake Interrupt Sample</a></li><li><a href=../../../../docs/in6xxe/examples-and-use-case/driver-examples/gpio-wake-sample.html>GPIO Wake Sample</a></li><li><a href=../../../../docs/in6xxe/examples-and-use-case/driver-examples/i2c-sample.html>I2C Sample</a></li><li><a href=../../../../docs/in6xxe/examples-and-use-case/driver-examples/keyboard-sample.html>Keyboard Sample</a></li><li><a href=../../../../docs/in6xxe/examples-and-use-case/driver-examples/pwm-sample.html>PWM Sample</a></li><li><a href=../../../../docs/in6xxe/examples-and-use-case/driver-examples/qdec-sample.html>QDEC Sample</a></li><li><a href=../../../../docs/in6xxe/examples-and-use-case/driver-examples/spi-sample.html>SPI Sample</a></li><li><a href=../../../../docs/in6xxe/examples-and-use-case/driver-examples/timer-sample.html>Timer Sample</a></li><li><a href=../../../../docs/in6xxe/examples-and-use-case/driver-examples/trigger-example-guide.html>Trigger Sample</a></li><li><a href=../../../../docs/in6xxe/examples-and-use-case/driver-examples/uart-sample-guide.html>UART Sample</a></li></ul></li><li><input type=checkbox id=section-542a43954a490ea3485a8e09b1381781 class=toggle>
<label for=section-542a43954a490ea3485a8e09b1381781 class="flex justify-between"><a role=button>Misc Examples</a></label><ul><li><a href=../../../../docs/in6xxe/examples-and-use-case/misc/hci-sample.html>HCI Sample</a></li></ul></li><li><input type=checkbox id=section-48884cb02637a51d8702e5e3edfef40c class=toggle>
<label for=section-48884cb02637a51d8702e5e3edfef40c class="flex justify-between"><a role=button>BLE Examples</a></label><ul><li><a href=../../../../docs/in6xxe/examples-and-use-case/ble/ble-advertising-sample.html>BLE advertising Sample</a></li><li><a href=../../../../docs/in6xxe/examples-and-use-case/ble/ble-gatt-sample.html>BLE GATT Sample</a></li><li><a href=../../../../docs/in6xxe/examples-and-use-case/ble/ble-initiation-sample.html>BLE Initiation Sample</a></li><li><a href=../../../../docs/in6xxe/examples-and-use-case/ble/ble-keyboard-sample.html>BLE Keyboard Sample</a></li><li><a href=../../../../docs/in6xxe/examples-and-use-case/ble/ble-scan-sample.html>BLE Scan Sample</a></li><li><a href=../../../../docs/in6xxe/examples-and-use-case/ble/ble-transparent-transmission-sample.html>BLE Transparent Transmission Sample</a></li></ul></li><li><input type=checkbox id=section-f989d19f5bf8a5459f7ee77a2dbc2a37 class=toggle>
<label for=section-f989d19f5bf8a5459f7ee77a2dbc2a37 class="flex justify-between"><a role=button>SDR Examples</a></label><ul><li><a href=../../../../docs/in6xxe/examples-and-use-case/sdr/sdr-1-master-to-multiple-slave-sample.html>SDR 1 to n Sample</a></li><li><a href=../../../../docs/in6xxe/examples-and-use-case/sdr/sdr-broadcast-sample-.html>SDR Broadcast Sample</a></li></ul></li></ul></li><li><input type=checkbox id=section-ecb777ba06679db84f6d08dc316cb5b2 class=toggle>
<label for=section-ecb777ba06679db84f6d08dc316cb5b2 class="flex justify-between"><a role=button>Development Kits</a></label><ul><li><a href=../../../../docs/in6xxe/dk/introduction-to-in6xxe-dk.html>Introduction to IN6XXE DK</a></li></ul></li></ul></li><li><input type=checkbox id=section-0bc0ac0bfec6b1ae25463138a2ae299e class=toggle>
<label for=section-0bc0ac0bfec6b1ae25463138a2ae299e class="flex justify-between"><a role=button>Solutions</a></label><ul><li><input type=checkbox id=section-f3c900f3ced930b282424e06187e7b20 class=toggle>
<label for=section-f3c900f3ced930b282424e06187e7b20 class="flex justify-between"><a role=button>Find My</a></label><ul><li><a href=../../../../docs/solutions/find-my/find-my-sdk-guide.html>Find My Sdk Guide</a></li></ul></li><li><input type=checkbox id=section-01b7a4cd745504c7ef54cce6910e09a8 class=toggle>
<label for=section-01b7a4cd745504c7ef54cce6910e09a8 class="flex justify-between"><a role=button>MultiConnNet</a></label><ul><li><a href=../../../../docs/solutions/multiconnnet/introduction.html>Introduction</a></li><li><a href=../../../../docs/solutions/multiconnnet/command-set.html>Module Instruction Set</a></li><li><a href=../../../../docs/solutions/multiconnnet/user-guild.html>User Guild</a></li></ul></li><li><input type=checkbox id=section-afc3c4284a3a81612ced6ce66dbe01d3 class=toggle>
<label for=section-afc3c4284a3a81612ced6ce66dbe01d3 class="flex justify-between"><a role=button>SMULL Pass-through Network</a></label><ul><li><a href=../../../../docs/solutions/smull/inplay-smull-development-guide.html>SMULL Command Set</a></li></ul></li><li><input type=checkbox id=section-3c853b7573728b720bb9f6d05f87354b class=toggle>
<label for=section-3c853b7573728b720bb9f6d05f87354b class="flex justify-between"><a role=button>Stellar</a></label><ul><li><a href=../../../../docs/solutions/stellar/stellar-gateway-wireless-communication-protocol-implementation-guide.html>Wireless Communication Protocol</a></li></ul></li><li><input type=checkbox id=section-15c87bcd4d931f9a897cb9565047755d class=toggle>
<label for=section-15c87bcd4d931f9a897cb9565047755d class="flex justify-between"><a role=button>Wireless Modbus Network</a></label><ul><li><a href=../../../../docs/solutions/modbus/wireless-modbus-demo-guide.html>Wireless Modbus Demo Guide</a></li><li><a href=../../../../docs/solutions/modbus/wireless-modbus-module.html>Wireless Modbus Module</a></li></ul></li></ul></li><li><input type=checkbox id=section-7e7f18f2dd14f1d43dd9be3434b07e7b class=toggle>
<label for=section-7e7f18f2dd14f1d43dd9be3434b07e7b class="flex justify-between"><a role=button>IN6XX</a></label><ul><li><input type=checkbox id=section-63252a7c2c256e222256d33b9f7363a6 class=toggle>
<label for=section-63252a7c2c256e222256d33b9f7363a6 class="flex justify-between"><a role=button>Getting Started</a></label><ul><li><input type=checkbox id=section-7e1496f76a7a40a604ce733f3e2bdacf class=toggle>
<label for=section-7e1496f76a7a40a604ce733f3e2bdacf class="flex justify-between"><a role=button>Installation</a></label><ul><li><a href=../../../../docs/in6xx/getting-started/installation/quick-start.html>Quick Start</a></li></ul></li><li><input type=checkbox id=section-7c5cc973fcb5ebb7f1a051dd9211755c class=toggle>
<label for=section-7c5cc973fcb5ebb7f1a051dd9211755c class="flex justify-between"><a role=button>Configration and Building</a></label><ul></ul></li><li><input type=checkbox id=section-fb6709c7bc2f74dd748ca851379bed41 class=toggle>
<label for=section-fb6709c7bc2f74dd748ca851379bed41 class="flex justify-between"><a role=button>Download Image</a></label><ul><li><a href=../../../../docs/in6xx/getting-started/download/in_prog-guide.html>InPlay Programmer Guide</a></li><li><a href=../../../../docs/in6xx/getting-started/download/jflash-download-guide.html>JFlash Programming</a></li><li><a href=../../../../docs/in6xx/getting-started/download/mp-tool-guide.html>MP Tool Guide</a></li></ul></li><li><input type=checkbox id=section-ed9f99fe4754a35a21fe02be8b0cb4f7 class=toggle>
<label for=section-ed9f99fe4754a35a21fe02be8b0cb4f7 class="flex justify-between"><a role=button>Testing and Debuging</a></label><ul><li><a href=../../../../docs/in6xx/getting-started/testing/rtt-viewer-guide.html>Rtt Viewer Guide</a></li><li><a href=../../../../docs/in6xx/getting-started/testing/debug-guide.html>Debug Guide</a></li><li><a href=../../../../docs/in6xx/getting-started/testing/hci_command.html>HCI Command</a></li></ul></li></ul></li><li><input type=checkbox id=section-4180a1cd8bda36e24d2a9c527ab046fe class=toggle>
<label for=section-4180a1cd8bda36e24d2a9c527ab046fe class="flex justify-between"><a role=button>Protocol Reference</a></label><ul><li><input type=checkbox id=section-7dd9db7eea8acbc738b8e6a6e64afef0 class=toggle>
<label for=section-7dd9db7eea8acbc738b8e6a6e64afef0 class="flex justify-between"><a role=button>BLE</a></label><ul><li><a href=../../../../docs/in6xx/protocol-reference/ble/gatt-programming-guide.html>GATT Programming Guide</a></li><li><a href=../../../../docs/in6xx/protocol-reference/ble/inplay_trx_profile.html>Inplay Transparent Data Transmission (TRx) profile User Guide</a></li></ul></li></ul></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=../../../../svg/menu.svg class=book-icon alt=Menu>
</label><strong>Inplay Transparent Data Transmission (TRx) profile User Guide</strong>
<label for=toc-control><img src=../../../../svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ol><li><a href=#overview>Overview</a></li><li><a href=#server>Server</a></li><li><a href=#client>Client</a></li></ol></nav></aside></header><article class=markdown><h1 id=inplay-transparent-data-transmission-trx-profile-user-guide>Inplay Transparent Data Transmission (TRx) profile User Guide
<a class=anchor href=#inplay-transparent-data-transmission-trx-profile-user-guide>#</a></h1><h2 id=overview>Overview
<a class=anchor href=#overview>#</a></h2><p>The Inplay Transparent Data Transmission (TRx) profile is a GATT based profile that fullfill tranparent data transmission function through BLE protocol. It encapsulates most of the details of the protocol stack and provides a simple interface to facilitate application development. For Inplay BLE application development, please refer to &mldr; For details about GATT programming please refer to <a href=https://inplay-inc.github.io/docs//in6xx/protocol-reference/ble/gatt-programming-guide.html>GATT Programming Guide</a></p><p>The TRx profile consists of the Server and the Client component. The server creates TRx service, in which two major characteristic values representing data receiving (Rx) and data transmitting (Tx) are included as well as a client characteristic configuration descriptor which controls whether server is allowed to send data or not.  Once a client is connected, the server will notify the client of the maximum size of data transmission it supports through MTU exchange. The client obtains the handles of the characteristics including Rx, Tx and Configure through the method of GATT Service Discovery so that it can send data through the method of GATT Write. The server sends data to the other party through the method of GATT Notify.</p><p>All the functions of profile must be called after BLE is initialized by <strong>ble_stack_init</strong> and <strong>ble_api_init</strong>, when ble_app.c in common directory of SDK is recommended to be used, though not madatory. The following sample codes are from <em>proj/BLE/proj_ble_trx_clt</em> and <em>proj/BLE/proj_ble_trx_svc</em>.</p><h2 id=server>Server
<a class=anchor href=#server>#</a></h2><p>Generally speeking, the data producer who transmits data to the other peer without active read request, will act as TRx server. The method with which server transmits data is called GATT notify or GATT indicate. The TRx server source code is included among <em>in_trx_svc.c</em> under <em>proj/common/util</em> directory in SDK.</p><p>The first step application should do is to call <strong>in_trx_svc_add</strong> to create GATT service in the server. The API prototype and associated structure are as belows.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>typedef</span> <span style=color:#50fa7b>int</span> (<span style=color:#ff79c6>*</span><span style=color:#8be9fd>trx_rx_cb_t</span>)(<span style=color:#8be9fd>int</span> conidx, <span style=color:#8be9fd>void</span><span style=color:#ff79c6>*</span> data, <span style=color:#8be9fd>int</span> data_len);
</span></span><span style=display:flex><span><span style=color:#ff79c6>typedef</span> <span style=color:#50fa7b>int</span> (<span style=color:#ff79c6>*</span><span style=color:#8be9fd>trx_state_cb_t</span>)(<span style=color:#8be9fd>int</span> conidx, <span style=color:#8be9fd>int</span> val);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>typedef</span> <span style=color:#ff79c6>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/// Customized service and characteristic UUID. @see TRX_SVC_UUID
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#8be9fd>uint8_t</span> 		uuid[<span style=color:#bd93f9>3</span>][BLE_UUID_128_LEN];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/// Service&#39;s start attribute handle.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#6272a4>/// If 0, start handle is allocated by protocol stack and returned.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#6272a4>/// Otherwise, start handle is designated and function may return
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#6272a4>/// failed if it is already allocated.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#8be9fd>uint16_t</span> 		start_hdl;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/// This callback will be called in gatt write request funtion
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#8be9fd>trx_rx_cb_t</span>	 	rx_callback;
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/// This callback will be called when client enable/disable notify
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#8be9fd>trx_state_cb_t</span>  tx_en_callback;
</span></span><span style=display:flex><span>} <span style=color:#8be9fd>in_trx_svc_t</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4> ****************************************************************************************
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @brief Add trx service
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @param[in] p_in_trx_svc  Contains parameter for service @see in_trx_svc_t
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @return 					&lt;0	: Fail. The absolute value is error @see enum in_ble_err_t.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>							other : Success. The value is service&#39;s start handle
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *
</span></span></span><span style=display:flex><span><span style=color:#6272a4> ****************************************************************************************
</span></span></span><span style=display:flex><span><span style=color:#6272a4> */</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>in_trx_svc_add</span>(<span style=color:#8be9fd>in_trx_svc_t</span> <span style=color:#ff79c6>*</span>p_in_trx_svc);
</span></span></code></pre></div><p>The input structure contains all the parameters that service needed. It&rsquo;s very simple for application so that focuses can be only on data itself.</p><p><code>uuid</code> contains three UUIDs each for service, characteristic representing server transmission, characteristic representing server reception. Default UUIDs are defined in in_trx_svc.h and user can change to theirs of course.</p><p><code>start_hdl</code> specifies how service locates in GATT profile. As mentioned in the comment, it&rsquo;s like the difference between dynamic memory allocation and static specifying a memory address. If the specified address conflicts with other memory addresses, it will result in an error.</p><p><code>rx_callback</code> is the application&rsquo;s callback function when data is received from peer device (client).</p><p><code>tx_en_callback</code> is the application&rsquo;s callback function when peer device (client) disables server transmitting data. As said before, server transmits data in a manner that do not require client&rsquo;s active read request. So that server provides a mechanism for client to enable or disable server transmission. When it happens, application is notified throuth this function, if it is not NULL.</p><p><code>conidx</code> in both callback functions represents peer device (client), which is assigned by BLE stack after connection is established. Since multi-connection topology is available in BLE, TRx service supports multi clients.</p><p>If the service has security requirement, call following function to set security.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4> ****************************************************************************************
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @brief set service&#39;s SMP right
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @param[in] perm	permission @see enum ble_att_perm
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @return 			&lt;0	: Fail. The absolute value represents possible error @see enum in_ble_err_t
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *					other : Success.
</span></span></span><span style=display:flex><span><span style=color:#6272a4> ****************************************************************************************
</span></span></span><span style=display:flex><span><span style=color:#6272a4> */</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>in_trx_svc_set_perm</span>(<span style=color:#ff79c6>enum</span> ble_att_perm perm);
</span></span></code></pre></div><p>Here is sample how TRx service is created:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>	<span style=color:#6272a4>/// initialize stack
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>h_bstk <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>ble_stack_init</span>(bd_addr);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/// initialize stack api
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	res <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>ble_api_init</span>(cbf, comp_cbf);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	****************************************************************************************
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	* @brief Add trx service
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	* @note get more information in in_trx_svc.h
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	*
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	****************************************************************************************
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	*/</span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>in_trx_svc_t</span> trx_svc <span style=color:#ff79c6>=</span> {.uuid<span style=color:#ff79c6>=</span>{TRX_SVC_UUID,TRX_RX_UUID,TRX_TX_UUID},.start_hdl<span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span>,.rx_callback<span style=color:#ff79c6>=</span>trx_rx_cb,.tx_en_callback<span style=color:#ff79c6>=</span>trx_tx_en_cb};
</span></span><span style=display:flex><span>	res <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>in_trx_svc_add</span>(<span style=color:#ff79c6>&amp;</span>trx_svc);
</span></span></code></pre></div><p>Now TRx server is ready and application is able to transmit and receive data once it is connected with peer client.</p><p>The server transmits data to the client by:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4> ****************************************************************************************
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @brief Trx notify function
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @param[in] conidx	Connection index
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @param[in] data		notify data buffer
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @param[in] len	   notify data length
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @param[in] ack	   gatt indicate method is used when true
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @return 				&lt;0	: Fail. The absolute value represents possible error @see enum in_ble_err_t
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *						other : Success.
</span></span></span><span style=display:flex><span><span style=color:#6272a4> ****************************************************************************************
</span></span></span><span style=display:flex><span><span style=color:#6272a4> */</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>in_trx_notify</span>(<span style=color:#8be9fd>int</span> conidx, <span style=color:#8be9fd>uint8_t</span> <span style=color:#ff79c6>*</span>data, <span style=color:#8be9fd>uint32_t</span> len, <span style=color:#8be9fd>bool</span> ack);
</span></span></code></pre></div><p><code>conidx</code> has the same meaning with that in callback function.</p><p><code>ack</code> differentiate which method is used to transmit data, notify when <code>ack</code> is false or indicate otherwise. Details about difference of them please refer to <a href=https://inplay-inc.github.io/docs//in6xx/protocol-reference/ble/gatt-programming-guide.html>GATT Programming Guide</a>.</p><p>Application is informed by <code>rx_callback</code> function when the data is received from the client. Here the data is copied to application&rsquo;s memory and return as soon as possible.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>trx_rx_cb</span>(<span style=color:#8be9fd>int</span> conidx, <span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>buf, <span style=color:#8be9fd>int</span> len)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>PRINTD</span>(DBG_TRACE, <span style=color:#f1fa8c>&#34;TRX RX: len=%d</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, len);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>msg_t</span> <span style=color:#ff79c6>*</span>p_msg <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>msg_t</span><span style=color:#ff79c6>*</span>)<span style=color:#50fa7b>malloc</span>(<span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>msg_t</span>)<span style=color:#ff79c6>+</span>len);
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (p_msg) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		p_msg<span style=color:#ff79c6>-&gt;</span>msg_id <span style=color:#ff79c6>=</span> MSG_DATA_RX;
</span></span><span style=display:flex><span>		p_msg<span style=color:#ff79c6>-&gt;</span>msg_len <span style=color:#ff79c6>=</span> len;
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>memcpy</span>(p_msg<span style=color:#ff79c6>-&gt;</span>msg, buf, len);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#8be9fd>int</span> res <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>osMessagePut</span>(g_app_msg_q_id, (<span style=color:#8be9fd>uint32_t</span>)p_msg, osWaitForever) ;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (res) {
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>PRINTD</span>(DBG_TRACE, <span style=color:#f1fa8c>&#34;put msg  err %X </span><span style=color:#f1fa8c>\r\n</span><span style=color:#f1fa8c>&#34;</span>, res);
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>free</span>(p_msg);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=client>Client
<a class=anchor href=#client>#</a></h2><p>Accordingly, the data consummer on the peer side will act as TRx client. The method with which client transmits data is called GATT write. The TRx client source code is included among <em>in_trx_clt.c</em> under <em>proj/common/util</em> directory in SDK.</p><p>Similarly, TRx client should be initialized first by:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>typedef</span> <span style=color:#ff79c6>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/// Service UUID
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#8be9fd>uint8_t</span> 		svc_uuid[BLE_UUID_128_LEN];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/// Service&#39;s start attribute handle. 
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#6272a4>/// If not 0, it is known beforehand and Service Discovery Procedure (SDP) is not performed. 
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#8be9fd>uint16_t</span> 		start_hdl;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/// Client&#39;s MTU
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#8be9fd>int</span> 			max_data_len;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/// This callback will be called in gatt notification event
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#8be9fd>trx_rx_cb_t</span>		rx_callback;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/// This callback will be called when client is ready to send/receive data
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#8be9fd>trx_state_cb_t</span>	ready_callback;
</span></span><span style=display:flex><span>} <span style=color:#8be9fd>in_trx_clt_t</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4> ****************************************************************************************
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @brief Init trx client. This must be called after BLE stack and system is initialized
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @param[in] p_trx_clt		Contains parameter for client @see in_trx_clt_t
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @return					&gt;=0: Success. 
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *							&lt;0 : Fail. The absolute value represents possible error 
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *								 @see enum in_ble_err_t.
</span></span></span><span style=display:flex><span><span style=color:#6272a4> ****************************************************************************************
</span></span></span><span style=display:flex><span><span style=color:#6272a4> */</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>in_trx_clt_init</span>(<span style=color:#8be9fd>in_trx_clt_t</span> <span style=color:#ff79c6>*</span>p_trx_clt);
</span></span></code></pre></div><p>The parameters are very similar to server service creatation function <strong>in_trx_svc_add</strong>. The only small difference is that if <code>start_hdl</code> is 0, the client will initiate the SDP procedure to obtain information about the service. Once it is done, <code>ready_callback</code> function is called so that application is informed whether or not TRx client is ready to work. The duration of SDP depends on the connection interval. The client will automatically adjust the connection interval to the minimum to fasten the SDP procedure, and then adjust them back to the original application-defined connection parameters when finished.</p><p>Here is the sample on how TRx client is initialized:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>	<span style=color:#6272a4>/// initialize stack
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>h_bstk <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>ble_stack_init</span>(bd_addr);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/// initialize stack api
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	res <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>ble_api_init</span>(cbf, comp_cbf);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	****************************************************************************************
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	* @brief Initialize Client trx
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	* @note get more information in in_trx_clt.h
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	*
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	****************************************************************************************
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	*/</span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>in_trx_clt_t</span> in_trx_clt <span style=color:#ff79c6>=</span> {.svc_uuid<span style=color:#ff79c6>=</span>{TRX_SVC_UUID}, .start_hdl<span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span>, .max_data_len<span style=color:#ff79c6>=</span>TRX_MAX_LEN, .rx_callback<span style=color:#ff79c6>=</span>trx_rx_cb, .ready_callback<span style=color:#ff79c6>=</span>trx_ready_cb};
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>in_trx_clt_init</span>(<span style=color:#ff79c6>&amp;</span>in_trx_clt);
</span></span></code></pre></div><p>The SDP procedure is started by calling <strong>in_trx_clt_start</strong> when client device is connected with peer server device and connection is acceptable by application.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4> ****************************************************************************************
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @brief Start trx client once connection is confirmed. This must be called after 
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * 		  in_trx_clt_init is called successfully.
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @param[in] conidx		ID allocated by BLE stack after the connection is established 
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *							with peer device
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @param[in] bd_addr		peer device&#39;s BLE mac address
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @return					&gt;=0: Success.
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *							&lt;0:  Fail. The absolute value represents possible error
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *								 @see enum in_ble_err_t.
</span></span></span><span style=display:flex><span><span style=color:#6272a4> ****************************************************************************************
</span></span></span><span style=display:flex><span><span style=color:#6272a4> */</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>in_trx_clt_start</span>(<span style=color:#8be9fd>int</span> conidx, <span style=color:#8be9fd>uint8_t</span> bd_addr[BLE_BDADDR_LEN]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>main_task</span>(<span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>h_bstk)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>int</span> res;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>while</span> (<span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span>		osEvent evt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		evt <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>osMessageGet</span>(g_app_msg_q_id, osWaitForever);
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (evt.status <span style=color:#ff79c6>==</span> osEventMessage)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#8be9fd>msg_t</span> <span style=color:#ff79c6>*</span>p_msg <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>msg_t</span><span style=color:#ff79c6>*</span>)evt.value.p;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>PRINTD</span>(DBG_TRACE, <span style=color:#f1fa8c>&#34;==&gt;%s</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, MSG_ID_STR[p_msg<span style=color:#ff79c6>-&gt;</span>msg_id]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>switch</span> (p_msg<span style=color:#ff79c6>-&gt;</span>msg_id)
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>case</span> <span style=color:#8be9fd;font-style:italic>MSG_CON</span>:
</span></span><span style=display:flex><span>				g_conidx <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>*</span>((<span style=color:#8be9fd>int</span><span style=color:#ff79c6>*</span>)p_msg<span style=color:#ff79c6>-&gt;</span>msg);
</span></span><span style=display:flex><span>				res <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>in_trx_clt_start</span>(g_conidx, p_msg<span style=color:#ff79c6>-&gt;</span>msg<span style=color:#ff79c6>+</span><span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>int</span>));
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>default</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>free</span>(p_msg);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <em>MSG_CON</em> message is posed to main task when application receives BLE event <em>GAP_EVT_CONN_REQ</em> via registered callback function. Here is sample about how callback function is registered.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>main</span>(<span style=color:#8be9fd>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	****************************************************************************************
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	* @brief Set ble related callback
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	* @note more information of this function can be found in ble_evt_cbf_t
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	*
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	****************************************************************************************
</span></span></span><span style=display:flex><span><span style=color:#6272a4>	*/</span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>ble_evt_cbf_t</span><span style=color:#ff79c6>*</span> cbf <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>ble_app_get_default_evt_cb</span>();
</span></span><span style=display:flex><span>	cbf<span style=color:#ff79c6>-&gt;</span>gap.evt_disconnect <span style=color:#ff79c6>=</span> ble_disconnect;
</span></span><span style=display:flex><span>	cbf<span style=color:#ff79c6>-&gt;</span>gap.evt_conn_ind <span style=color:#ff79c6>=</span> ble_connect;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4>****************************************************************************************
</span></span></span><span style=display:flex><span><span style=color:#6272a4>* @brief callback for ble connection
</span></span></span><span style=display:flex><span><span style=color:#6272a4>* @param[out] req	request of ble connection.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>* @param[out] cfm Connection request confirm structure.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>* @note we can get information in ble_evt_conn_req_t and ble_conn_cfm_t
</span></span></span><span style=display:flex><span><span style=color:#6272a4>*
</span></span></span><span style=display:flex><span><span style=color:#6272a4>****************************************************************************************
</span></span></span><span style=display:flex><span><span style=color:#6272a4>*/</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>ble_connect</span>(<span style=color:#8be9fd>ble_evt_conn_req_t</span><span style=color:#ff79c6>*</span> req, <span style=color:#8be9fd>ble_conn_cfm_t</span><span style=color:#ff79c6>*</span> cfm)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>uint8_t</span> <span style=color:#ff79c6>*</span>addr <span style=color:#ff79c6>=</span> req<span style=color:#ff79c6>-&gt;</span>peer_addr.addr;
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>PRINTD</span>(DBG_TRACE, <span style=color:#f1fa8c>&#34;ble_connect  Connect  0x%02x:0x%02x:0x%02x:0x%02x:0x%02x:0x%02x  conid:%d intv:0x%x lantency:0x%x timeout:0x%x clock:0x%x***</span><span style=color:#f1fa8c>\r\n</span><span style=color:#f1fa8c>&#34;</span>,
</span></span><span style=display:flex><span>		   addr[<span style=color:#bd93f9>0</span>], addr[<span style=color:#bd93f9>1</span>],addr[<span style=color:#bd93f9>2</span>],addr[<span style=color:#bd93f9>3</span>],addr[<span style=color:#bd93f9>4</span>],addr[<span style=color:#bd93f9>5</span>], req<span style=color:#ff79c6>-&gt;</span>conidx, req<span style=color:#ff79c6>-&gt;</span>con_interval, req<span style=color:#ff79c6>-&gt;</span>con_latency, req<span style=color:#ff79c6>-&gt;</span>sup_to, req<span style=color:#ff79c6>-&gt;</span>clk_accuracy);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd>msg_t</span> <span style=color:#ff79c6>*</span>p_msg <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>msg_t</span><span style=color:#ff79c6>*</span>)<span style=color:#50fa7b>malloc</span>(<span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>msg_t</span>)<span style=color:#ff79c6>+</span><span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>int</span>)<span style=color:#ff79c6>+</span><span style=color:#bd93f9>6</span>);
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (p_msg) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		p_msg<span style=color:#ff79c6>-&gt;</span>msg_id <span style=color:#ff79c6>=</span> MSG_CON;
</span></span><span style=display:flex><span>		p_msg<span style=color:#ff79c6>-&gt;</span>msg_len <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>*</span>((<span style=color:#8be9fd>int</span><span style=color:#ff79c6>*</span>)p_msg<span style=color:#ff79c6>-&gt;</span>msg) <span style=color:#ff79c6>=</span> req<span style=color:#ff79c6>-&gt;</span>conidx;
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>memcpy</span>(p_msg<span style=color:#ff79c6>-&gt;</span>msg<span style=color:#ff79c6>+</span><span style=color:#ff79c6>sizeof</span>(<span style=color:#8be9fd>int</span>), req<span style=color:#ff79c6>-&gt;</span>peer_addr.addr, <span style=color:#bd93f9>6</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#8be9fd>int</span> res <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>osMessagePut</span>(g_app_msg_q_id, (<span style=color:#8be9fd>uint32_t</span>)p_msg, <span style=color:#bd93f9>0</span>) ;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (res) {
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>PRINTD</span>(DBG_TRACE, <span style=color:#f1fa8c>&#34;put msg  err %X </span><span style=color:#f1fa8c>\r\n</span><span style=color:#f1fa8c>&#34;</span>, res);
</span></span><span style=display:flex><span>			<span style=color:#50fa7b>free</span>(p_msg);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>After SDP procudure is end, <code>ready_callback</code> function that is passed when initialization is called to inform application whether success or not. Here is sample of ready callback function.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>static</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>trx_ready_cb</span>(<span style=color:#8be9fd>int</span> conidx, <span style=color:#8be9fd>int</span> res)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#50fa7b>PRINTD</span>(DBG_TRACE, <span style=color:#f1fa8c>&#34;trx ready: 0x%x</span><span style=color:#f1fa8c>\r\n</span><span style=color:#f1fa8c>&#34;</span>, res);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	g_trx_svc_ready <span style=color:#ff79c6>=</span> res;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> ( g_conidx <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span> <span style=color:#ff79c6>&amp;&amp;</span> g_trx_svc_ready <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>&amp;&amp;</span> g_trx_ntf_en <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>false</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		g_trx_ntf_en <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>;
</span></span><span style=display:flex><span>		res <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>in_trx_clt_enable_ntf</span>(g_conidx, g_trx_ntf_en);
</span></span><span style=display:flex><span>		<span style=color:#50fa7b>PRINTD</span>(DBG_TRACE, <span style=color:#f1fa8c>&#34;trx notify %s</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, g_trx_ntf_en <span style=color:#ff79c6>?</span> <span style=color:#f1fa8c>&#34;enabled&#34;</span> <span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#34;disabled&#34;</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It calls <strong>in_trx_clt_enable_ntf</strong> function to enable server to transmit data for both GATT notify and indicate. Till now, client is ready to exchange data with peer server. To transmit data call <strong>in_trx_clt_send</strong>, whose parameters are the same as those of the server function.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4> ****************************************************************************************
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @brief Trx Client sends data. If Service Discovery Procedure (SDP) is on-going, it is 
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *        not allowed to send data.
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @param[in] conidx	connection index of peer
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @param[in] p_data	notify data buffer
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @param[in] data_len  notify data length
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @param[in] ack	    use GATT_WRITE_NO_RESPONSE write method if false
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @return					&gt;=0: Success.
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *							&lt;0:  Fail. The absolute value represents possible error
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *								 @see enum in_ble_err_t.
</span></span></span><span style=display:flex><span><span style=color:#6272a4> ****************************************************************************************
</span></span></span><span style=display:flex><span><span style=color:#6272a4> */</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>in_trx_clt_send</span>(<span style=color:#8be9fd>int</span> conidx, <span style=color:#8be9fd>uint8_t</span> <span style=color:#ff79c6>*</span>p_data, <span style=color:#8be9fd>uint16_t</span> data_len, <span style=color:#8be9fd>bool</span> ack);
</span></span></code></pre></div><p>Similar to server, when data is received, <code>rx_callback</code> function is called. Sample is same as that in server.</p><p>Here is Sequence Diagram to summarize the use of TRx profile.</p><p><img src=../../../../images/in_trx_sequence_diagram.png alt="Tranparent Data Transmission Sequence Diagram"></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ol><li><a href=#overview>Overview</a></li><li><a href=#server>Server</a></li><li><a href=#client>Client</a></li></ol></nav></div></aside><script src=../../../../js/fuse.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=../../../../js/mark.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=../../../../js/fastsearch.js crossorigin=anonymous referrerpolicy=no-referrer></script></main><footer class="bg-black bottom-0 w-100 pa3" style=position:fixed;bottom:0;width:100% role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" style=color:#000>&copy; Copyright 2025 InPlay Inc</a></div></footer></body></html>